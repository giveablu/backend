# Session Structure Log

_Last updated: 2025-10-20_

## Workspace Overview

- `backend/` – Laravel 10 (PHP 8.1+) API powering Blu Charity donor/recipient flows, Sanctum auth, PayPal checkout, and social verification pipeline.
- `blugives/` – Next.js 15 (React 19, TypeScript) frontend deployed to Vercel; replaces legacy `bluwebnext` app but reuses the same Laravel API.

## Backend (`backend/`)

- **Runtime & Entry Points**: `artisan` CLI, `public/index.php`; Sanctum guard configured in `config/sanctum.php`; primary HTTP surface defined in `routes/api.php` with role-specific prefixes (`auth`, `donor-account`, `receiver-account`, `profile/social`, `admin`, `meta`). Middleware stack includes Sanctum auth and custom `adminauth` for privileged routes.
- **Auth & Account Lifecycle**: Registration/OTP handled by `Api/Auth/RegisterController` + `OtpVerifyController`; password reset pipeline consolidated in `Api/Auth/ForgotPassController`; role switching via `AuthController@switchRole`; logout deletes Sanctum tokens. Social OAuth flows orchestrated by `SocialAuthController` (redirect/callback) and `SocialLoginController`, using Socialite helpers in `app/Services/SocialAuth/` with provider enums (`app/Enums/SocialProvider.php`) and verification status enum (`SocialVerificationStatus.php`).
- **Domain Modules**: Controllers grouped by responsibility – donor (`Api/Donor/*` for feed, profile, donations, notifications), receiver (`Api/Receiver/*` for post/bank/balance/withdraw/notifications), profile-linked accounts (`Api/Profile/*` managing linked providers), admin moderation (`Api/Admin/UserSocialController`). PayPal checkout handled by `PaypalController` (create/capture) and legacy helpers `PaypalPayment.php` / `PaypalPaymentOld.php`. Device tokens and contact forms covered by `DeviceTokenController` and `ContactUsController`.
- **Data & Persistence**: Eloquent models in `app/Models/` span `Donation`, `Post`, `DonorPreference`, `Notification`, `ImpactSnapshot`, `ImpactExample`, `SocialVerificationEvent`, `UserSocial`, etc. Migration timeline through October 2025 adds donation fee columns (`2025_10_04_180000`), user metadata/search fields (`2025_10_12_*`), donor preference table, and the social verification suite (`2025_10_15_*`). Seeders and factories support testing; impact examples and user preference defaults remain in database seeders.
- **Social Verification**: `user_socials` table now tracks provider enum, username, profile/avatar URLs, account age, follower counts, raw payload, sync timestamps, and `is_primary`. `users` table records `social_verified_at`, `social_verification_status`, `social_verification_notes`. `social_verification_events` log automated/manual status changes. Admin API allows moderators to inspect and override statuses.
- **Impact Pipeline**: `app/Console/Commands/SyncImpactSnapshots.php` ingests JSON feed (file/url) into `impact_snapshots`, versioning entries by timestamp. Configured via `config/services.php['impact_feed']` with optional API key; scheduled daily at 03:00 in `app/Console/Kernel.php`. Fallback examples remain in `ImpactExampleSeeder`; endpoint `GET /api/impact/estimate` exposes estimates to clients.
- **Background Work & Cleanup**: `PurgeStaleUnverifiedUsers` command purges accounts older than `UNVERIFIED_USER_RETENTION_DAYS` without verified email/phone, chunk size from `config/cleanup.php`. Scheduler also registered in `app/Console/Kernel.php`. Logs stored in `storage/logs`; queue worker defaults to database driver (configurable).
- **Payment Flow**: PayPal order creation/capture endpoints `POST /api/paypal/create-order` and `/capture-order` wrap the PayPal SDK; success/cancel GET routes support legacy flows. Donation metadata now includes platform fee columns per 2025 migrations.
- **Third-Party & Config**: `config/services.php` stores credentials for Mailgun/Postmark/SES, impact feed, Facebook, Instagram (with verify token), Twitter/X (OAuth 1 + 2), Google. `.env` expects PayPal, Firebase, Redis, mail, and social keys as documented in `docs/README.md` and `docs/social-login-verification.md`.
- **Documentation & Tooling**: Operational docs in `docs/` (architecture, enforcement, change logs, social login, impact data, auto-approved commands). PowerShell scripts in repo root (`cleanup-laravel-files.ps1`, `scripts/restart-stack.ps1`) standardize local dev workflow. Testing via `php artisan test`, coverage flag available; code style enforced with Laravel Pint (`composer pint`).

## Frontend (`blugives/`)

- **Framework & Tooling**: Next.js 15 App Router with React 19, TypeScript, Tailwind 3, Radix UI primitives, `lucide-react` icons, and shadcn-style component registry (`components.json`). Package management via `pnpm`; scripts in `package.json` (`dev`, `build`, `start`, `lint`). ESLint (`.eslintrc.json`), Tailwind (`tailwind.config.ts`), PostCSS, and TypeScript configs committed; `.npmrc` enforces lockfile.
- **Directory Layout**: `app/` hosts all routes—marketing (`app/page.tsx`), auth (`app/login`, `app/register`, `app/forgot-password`), donor experiences (`app/donate`, `app/profile`, `app/recipient`), compliance pages, API test harnesses (`app/api-debug`, `app/api-test*`), setup checks, whitepaper, roadmap, investor inquiries, etc. `components/` supplies shared UI (navigation, hero, donation modal/swiper, PayPal widgets, dashboards, chat widget). `lib/` contains API helper (`lib/api.ts`) and shared utilities; `hooks/`, `types/`, `styles/` (with `app/globals.css`) round out client functionality. Static assets stored under `public/`.
- **State, Forms & UX**: Forms leverage `react-hook-form` + `@hookform/resolvers/zod`; validation schemas live alongside components. Theming managed via `next-themes`; toasts using `sonner`; command palette via `cmdk`; OTP entry via `input-otp`; carousels with `embla-carousel-react`. Geo/helpers include `country-state-city`, `react-day-picker`, `recharts` for analytics displays.
- **API Integration**: `lib/api.ts` centralizes REST calls, reading `NEXT_PUBLIC_API_URL` (default `http://127.0.0.1:8000/api`, production fallback `https://service.blu.gives/api`). Auth tokens stored in localStorage keys `blu_auth_token` and `blu_user_data` per README; social verification data surfaced on profile components. Setup-check routes validate backend health (CORS, env alignment).
- **Environment & Deployment**: `.env.local.example` instructs copying to `.env.local`; `.env.production.local`, `.env.vercel`, and `.vercel/` files indicate active Vercel deployment. `.next/` build artifacts and `node_modules/` present from prior local runs; project confirmed running locally and in production.
- **Documentation & Planning**: `docs/ARCHITECTURE.md`, `docs/UI_MAPPING.md`, `docs/platform-update-roadmap.md`, `docs/ENFORCEMENT_PROTOCOL.md`, `docs/chatbot-setup.md`, `docs/CHANGE_LOG.md` align web app direction with the React Native UX (the documented source of truth). Additional strategy files (`integration-strategy.tsx`, `user-sync-strategy.tsx`, `wordpress-api-integration.tsx`) outline future integrations and automation plans.
- **Tooling & Scripts**: PowerShell helper (`cleanup-laravel-files.ps1`), automation under `scripts/`, shared navigation config in `shared-navigation.tsx`. Testing/linting via `pnpm lint` and Next.js test stack (not all scripts enumerated but noted in docs). Tailwind styling centralized in `app/globals.css` and component-specific styles.
